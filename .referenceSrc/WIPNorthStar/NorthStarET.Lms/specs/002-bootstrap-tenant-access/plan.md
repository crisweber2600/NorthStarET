# Implementation Plan: Tenant-Isolated District Access

**Branch**: `002-bootstrap-tenant-access` | **Date**: 2025-10-25 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-bootstrap-tenant-access/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command and reflects completed Phase 0 (research) and Phase 1 (design) artifacts.

## Summary

Bootstrap the LMS with secure, tenant-isolated district management where a System Admin can create, edit, and delete districts with unique email domain suffixes, delegate District Admin roles via invitation with verification tracking, and enforce strict tenant isolation preventing any cross-district data visibility. Implements District and DistrictAdmin aggregates with idempotent create/update operations (10-minute window), invite resend with exponential backoff retry, soft-delete with immediate access revocation, and comprehensive audit trail. All operations orchestrated via .NET Aspire with PostgreSQL 16, Redis Stack for idempotency, and domain event publishing to Azure Event Grid.

## Technical Context

**Language/Version**: C# 12 / .NET 9.0  
**Primary Dependencies**:

- MediatR 11 (CQRS pattern)
- FluentValidation (input validation)
- Entity Framework Core 9 (PostgreSQL 16 provider)
- Redis Stack (idempotency + session caching)
- Aspire 9.0 (orchestration, service defaults)
- Microsoft.Identity.Web (Entra ID OIDC)

**Storage**:

- PostgreSQL 16 (authoritative data, audit log)
- Redis Stack (idempotency tokens, session cache)
- Azure Event Grid (domain event publishing via Aspire eventing extension)

**Testing**:

- xUnit (unit tests)
- Reqnroll (BDD feature files)
- Playwright (UI automation via PowerShell)
- Aspire test projects (integration/hosting validation)

**Target Platform**:

- ASP.NET Core 9 Minimal APIs + Controllers (API layer)
- Razor Pages (Web UI layer)
- Linux containers orchestrated via Aspire AppHost

**Project Type**: Clean Architecture web application with vertical slice organization

**Performance Goals**:

- P95 API response time < 500ms for district/admin operations
- Idempotency check < 10ms via Redis
- Audit query pagination < 100ms for 100 records

**Constraints**:

- 7-day absolute invite expiration from initial send
- 10-minute idempotency window for create/update operations
- Rate limiting: max 10 requests/min per user for invite/create endpoints
- ≥80% code coverage requirement
- No cross-district data visibility (enforced via EF Core global query filters + MediatR pipelines)

**Scale/Scope**:

- No hard user/district limits (designed for horizontal scaling)
- Soft delete with audit trail preservation
- Eventual consistency for domain events via outbox pattern

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

### Clean Architecture & Aspire Orchestration ✓

- **Status**: PASS
- **Evidence**:
  - Domain layer (`src/NorthStarET.NextGen.Lms.Domain`) defines aggregates with zero infrastructure dependencies
  - Application layer (`src/NorthStarET.NextGen.Lms.Application`) orchestrates use cases via MediatR; depends only on Domain
  - Infrastructure layer (`src/NorthStarET.NextGen.Lms.Infrastructure`) implements repository interfaces; isolated behind contracts
  - API/Web layers depend on Application only; no direct Infrastructure references
  - Aspire AppHost (`src/NorthStarET.NextGen.Lms.AppHost`) orchestrates PostgreSQL, Redis, API, Web services
  - ServiceDefaults (`src/NorthStarET.NextGen.Lms.ServiceDefaults`) applied uniformly across all services
  - Integration tests structured as Aspire projects validating hosting topology

### Test-Driven Quality Gates ✓

- **Status**: PASS
- **Evidence Plan**:
  - **Unit Tests**: TDD loop for command/query handlers, validators, domain logic
    - Red phase: Run `dotnet test tests/unit/NorthStarET.NextGen.Lms.Application.Tests` before implementation → capture failure output
    - Green phase: Run same command after implementation → capture success output
  - **BDD Tests**: Reqnroll feature files in `specs/002-bootstrap-tenant-access/features/` for FR-001 through FR-018
    - Red phase: Run `dotnet test tests/bdd/NorthStarET.NextGen.Lms.Bdd` with pending step definitions → capture failure
    - Green phase: Run after production code implementation → capture success
  - **Aspire Integration**: Validate service orchestration, configuration, cross-service flows
    - Red phase: Run `dotnet test tests/aspire/NorthStarET.NextGen.Lms.AspireTests` before wiring → capture failure
    - Green phase: Run after Aspire config complete → capture success
  - **Playwright UI**: Automate User Story 1 and User Story 2 journeys (with Figma links)
    - Red phase: Run `pwsh tests/ui/playwright.ps1` before UI implementation → capture failure
    - Green phase: Run after Razor Pages complete → capture success
  - **Coverage**: Maintain ≥80% via `dotnet test --collect:"XPlat Code Coverage"`
  - All 4 transcript pairs (Red + Green for unit/BDD, Aspire, Playwright) attached to phase review artifacts

### UX Traceability & Figma Accountability ✓

- **Status**: PASS
- **Evidence**:
  - User Story 1 (System Admin Manages Districts) — **P1** with Figma links:
    - District Management page: [22-2](https://www.figma.com/design/cXwWUeggyig95XE7pJqls3/NorthStarET.NextGen.Lms-UI?node-id=22-2&m=dev)
    - Create District button: [22-43](https://www.figma.com/design/cXwWUeggyig95XE7pJqls3/NorthStarET.NextGen.Lms-UI?node-id=22-43&m=dev)
    - Create New District modal: [22-67](https://www.figma.com/design/cXwWUeggyig95XE7pJqls3/NorthStarET.NextGen.Lms-UI?node-id=22-67&m=dev)
    - Edit District modal: [22-278](https://www.figma.com/design/cXwWUeggyig95XE7pJqls3/NorthStarET.NextGen.Lms-UI?node-id=22-278&m=dev)
  - User Story 2 (System Admin Delegates District Admins) — **P2** with Figma links:
    - Manage Admins page: [24-181](https://www.figma.com/design/cXwWUeggyig95XE7pJqls3/NorthStarET.NextGen.Lms-UI?node-id=24-181&m=dev)
    - Invite form fields: [24-285, 24-282, 24-288](https://www.figma.com/design/cXwWUeggyig95XE7pJqls3/NorthStarET.NextGen.Lms-UI?node-id=24-285&m=dev)
    - Admin status indicators: [24-410, 24-403](https://www.figma.com/design/cXwWUeggyig95XE7pJqls3/NorthStarET.NextGen.Lms-UI?node-id=24-410&m=dev)
  - User Story 3 (District Admin UX) — **P3 DEFERRED** (no Figma links; awaiting design)
  - All UI tasks tagged with `UI` label in tasks.md (to be generated by `/speckit.tasks`)
  - `figma-prompts/` directory exists for asynchronous contributor access to design specs

### Event-Driven Data Discipline ✓

- **Status**: PASS
- **Evidence**:
  - Domain events: DistrictCreated, DistrictUpdated, DistrictDeleted, DistrictAdminInvited, DistrictAdminVerified, DistrictAdminRevoked
  - Async publishing via Azure Event Grid (Aspire eventing extension)
  - Outbox pattern in Infrastructure ensures consistency with database commits
  - No synchronous cross-service calls introduced in this feature
  - All commands idempotent via Redis-backed tokens (10-minute window)
  - Event schema versioning in `DomainEventEnvelope.SchemaVersion` field

### Security & Compliance Safeguards ✓

- **Status**: PASS
- **Evidence**:
  - Authorization enforced in Application layer via MediatR pipeline behaviors
  - Tenant isolation: EF Core global query filters + explicit `DistrictId` checks in handlers
  - Role-based access: SystemAdmin vs DistrictAdmin roles from Entra ID claims
  - UI (Web/API) depends only on Application; no Infrastructure coupling
  - Secrets stored in Azure Key Vault (production) / User Secrets (development)
  - Audit trail captures actor, action, entity, timestamps for compliance
  - Rate limiting applied to invite/create endpoints (10 req/min per user)
  - Anti-CSRF tokens on state-changing operations
  - Input validation via FluentValidation (SQL injection/XSS prevention)

## Project Structure

## Project Structure

### Documentation (this feature)

```
specs/002-bootstrap-tenant-access/
├── spec.md              # Feature specification (user stories, requirements, success criteria)
├── plan.md              # This file (technical approach, constitution check, structure)
├── research.md          # Phase 0 output (technical decisions and rationale)
├── data-model.md        # Phase 1 output (entity definitions, relationships, validation)
├── quickstart.md        # Phase 1 output (build/run/test instructions)
├── contracts/           # Phase 1 output (OpenAPI schemas)
│   └── districts.openapi.yaml
├── features/            # Reqnroll BDD feature files (to be created during implementation)
├── checklists/          # Phase completion checklists
└── figma-prompts/       # Prompts for contributors without Figma MCP plugin
```

### Source Code (Clean Architecture with Aspire)

```
src/
├── NorthStarET.NextGen.Lms.Domain/
│   ├── Districts/                    # District aggregate root
│   │   ├── District.cs
│   │   ├── IDistrictRepository.cs
│   │   └── Events/
│   │       ├── DistrictCreated.cs
│   │       ├── DistrictUpdated.cs
│   │       └── DistrictDeleted.cs
│   ├── DistrictAdmins/               # DistrictAdmin aggregate
│   │   ├── DistrictAdmin.cs
│   │   ├── IDistrictAdminRepository.cs
│   │   └── Events/
│   │       ├── DistrictAdminInvited.cs
│   │       ├── DistrictAdminVerified.cs
│   │       └── DistrictAdminRevoked.cs
│   ├── Auditing/
│   │   └── AuditRecord.cs
│   └── Common/
│       └── DomainEvent.cs
│
├── NorthStarET.NextGen.Lms.Application/
│   ├── DependencyInjection.cs        # MediatR, validators registration
│   ├── Districts/
│   │   ├── Commands/
│   │   │   ├── CreateDistrictCommand.cs
│   │   │   ├── UpdateDistrictCommand.cs
│   │   │   └── DeleteDistrictCommand.cs
│   │   ├── Queries/
│   │   │   ├── GetDistrictQuery.cs
│   │   │   └── ListDistrictsQuery.cs
│   │   └── Validators/
│   │       ├── CreateDistrictValidator.cs
│   │       └── UpdateDistrictValidator.cs
│   ├── DistrictAdmins/
│   │   ├── Commands/
│   │   │   ├── InviteDistrictAdminCommand.cs
│   │   │   ├── ResendInviteCommand.cs
│   │   │   └── RevokeDistrictAdminCommand.cs
│   │   └── Queries/
│   │       └── ListDistrictAdminsQuery.cs
│   ├── Authorization/
│   │   └── TenantIsolationBehavior.cs  # MediatR pipeline for tenant filtering
│   └── Common/
│       └── IdempotencyBehavior.cs
│
├── NorthStarET.NextGen.Lms.Infrastructure/
│   ├── DependencyInjection.cs        # DbContext, repositories, Redis, Event Grid
│   ├── Districts/
│   │   ├── DistrictsDbContext.cs
│   │   ├── DistrictRepository.cs
│   │   ├── DistrictAdminRepository.cs
│   │   └── EntityConfigurations/
│   │       ├── DistrictConfiguration.cs
│   │       └── DistrictAdminConfiguration.cs
│   ├── Idempotency/
│   │   └── IdempotencyService.cs     # Redis-backed token storage
│   ├── Auditing/
│   │   └── AuditRepository.cs
│   └── Identity/
│       └── IdentityDbContext.cs      # Session storage (from 001-unified-sso-auth)
│
├── NorthStarET.NextGen.Lms.Contracts/
│   ├── Districts/
│   │   ├── CreateDistrictRequest.cs
│   │   ├── UpdateDistrictRequest.cs
│   │   └── DistrictResponse.cs
│   └── DistrictAdmins/
│       ├── InviteDistrictAdminRequest.cs
│       └── DistrictAdminResponse.cs
│
├── NorthStarET.NextGen.Lms.Api/
│   ├── Program.cs                    # Aspire Service Defaults, MediatR, auth
│   ├── Districts/
│   │   └── DistrictsController.cs    # REST endpoints for district CRUD
│   ├── DistrictAdmins/
│   │   └── DistrictAdminsController.cs
│   └── Audit/
│       └── AuditController.cs
│
├── NorthStarET.NextGen.Lms.Web/
│   ├── Program.cs                    # Razor Pages app
│   ├── Pages/
│   │   └── Admin/
│   │       ├── Districts/
│   │       │   ├── Index.cshtml      # District list (Figma 22-2)
│   │       │   ├── Create.cshtml     # Create district modal logic
│   │       │   └── Edit.cshtml       # Edit district modal logic
│   │       └── DistrictAdmins/
│   │           └── Manage.cshtml     # Manage admins (Figma 24-181)
│   └── wwwroot/
│       └── css/
│           └── districts.css
│
├── NorthStarET.NextGen.Lms.AppHost/
│   └── Program.cs                    # Aspire orchestration (PostgreSQL, Redis, API, Web)
│
└── NorthStarET.NextGen.Lms.ServiceDefaults/
    └── Extensions.cs                 # Shared telemetry, health checks, resilience

tests/
├── unit/
│   ├── NorthStarET.NextGen.Lms.Domain.Tests/
│   │   └── Districts/
│   │       ├── DistrictTests.cs
│   │       └── DistrictAdminTests.cs
│   ├── NorthStarET.NextGen.Lms.Application.Tests/
│   │   ├── Districts/
│   │   │   ├── CreateDistrictCommandHandlerTests.cs
│   │   │   └── UpdateDistrictCommandHandlerTests.cs
│   │   └── DistrictAdmins/
│   │       └── InviteDistrictAdminCommandHandlerTests.cs
│   └── NorthStarET.NextGen.Lms.Api.Tests/
│       └── Districts/
│           └── DistrictsControllerTests.cs
│
├── bdd/
│   └── NorthStarET.NextGen.Lms.Bdd/
│       ├── Features/
│       │   ├── DistrictManagement.feature
│       │   └── DistrictAdminDelegation.feature
│       └── StepDefinitions/
│           ├── DistrictSteps.cs
│           └── DistrictAdminSteps.cs
│
├── ui/
│   ├── playwright.config.ts
│   ├── playwright.ps1                # PowerShell test runner
│   └── tests/
│       ├── district-management.spec.ts
│       └── district-admin-delegation.spec.ts
│
├── aspire/
│   └── NorthStarET.NextGen.Lms.AspireTests/
│       └── AppHostTests.cs           # Validate service topology, health checks
│
└── integration/
    └── NorthStarET.NextGen.Lms.IntegrationTests/
        └── Districts/
            └── DistrictEndToEndTests.cs
```

**Structure Decision**: Clean Architecture enforced with Aspire orchestration. Domain aggregates remain pure; Application coordinates via MediatR; Infrastructure implements behind interfaces; API/Web depend on Application only. All services orchestrated through AppHost with ServiceDefaults for telemetry, health, and resilience.

## Complexity Tracking

_No constitution violations requiring justification. All principles satisfied:_

- Clean Architecture boundaries enforced across all layers
- Aspire orchestration with ServiceDefaults applied uniformly
- TDD with Red→Green evidence plan for unit, BDD, Aspire, Playwright suites
- Figma links provided for all P1/P2 UI stories; P3 deferred until design available
- Event-driven architecture with async domain event publishing
- Security safeguards: tenant isolation, role-based auth, secrets in platform store
